<?php

require_once('wp-load.php');

if (!defined('ABSPATH')) {
    exit;
}

if (!current_user_can('administrator')) {
    wp_die('Permesso negato, devi essere un amministratore per eseguire questa funzione.');
}

global $wpdb;

$results = $wpdb->get_results("
    SELECT post_id,
           MAX(CASE WHEN meta_key = '_yoast_wpseo_title' THEN meta_value END) AS meta_title,
           MAX(CASE WHEN meta_key = '_yoast_wpseo_metadesc' THEN meta_value END) AS meta_description
    FROM {$wpdb->prefix}postmeta
    WHERE meta_key IN ('_yoast_wpseo_title', '_yoast_wpseo_metadesc')
    GROUP BY post_id
");

if (empty($results)) {
    wp_die('Errore nella creazione del CSV, tabelle Yoast non trovate, il plugin Ã¨ installato?');
}

header('Content-Type: text/csv; charset=UTF-8');
header('Content-Disposition: attachment;filename="meta_yoast_esportato.csv"');

$output = fopen('php://output', 'w');
if ($output === false) {
    wp_die('Errore nella creazione del file CSV, tabelle vuote o corrotte. Prova a riparare le tabelle del db.');
}

fwrite($output, "\xEF\xBB\xBF");

// Divido il csv in 3 colonne separate
fputcsv($output, ['post_url', 'meta_title', 'meta_description']);

foreach ($results as $row) {
    $post_url = get_permalink($row->post_id);
    fputcsv($output, [$post_url, $row->meta_title, $row->meta_description]);
}

fclose($output);
exit;

?>
